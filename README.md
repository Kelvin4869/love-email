# Node ç¯å¢ƒä¸‹è½½

Node å®˜ç½‘ä¸‹è½½ï¼šhttp://nodejs.cn/download/



#  VS Code ç¼–è¾‘å™¨ä¸‹è½½

VS Codeä¸‹è½½ï¼š https://code.visualstudio.com/



# ğŸ’• é¡¹ç›®ä¸»è¦åŠŸèƒ½

1. åˆ©ç”¨Nodeå®ç°ç½‘é¡µçˆ¬è™«æŠ“å–æ•°æ®ã€‚
2. åˆ©ç”¨æ¨¡ç‰ˆå¼•æ“åˆ¶ä½œHTMLé‚®ä»¶ã€‚
3. åˆ©ç”¨Nodeå‘é€ç”µå­é‚®ä»¶ã€‚
4. åˆ©ç”¨Nodeå®ç°å®šæ—¶æ‰§è¡Œä»»åŠ¡ã€‚



## é¡¹ç›®ä¾èµ–åŒ…

| ä¾èµ–åŒ…åç§°         | åŠŸèƒ½æè¿°   | npm é¡¹ç›®åœ°å€                                 |
| ------------- | ------ | ---------------------------------------- |
| superagent    | HTTPè¯·æ±‚ | [æŸ¥çœ‹npmé¡¹ç›®åœ°å€](https://www.npmjs.com/package/superagent) |
| cheerio       | è§£æHTML | [æŸ¥çœ‹npmé¡¹ç›®åœ°å€](<https://www.npmjs.com/package/cheerio>) |
| art-template  | æ¨¡ç‰ˆå¼•æ“   | [æŸ¥çœ‹npmé¡¹ç›®åœ°å€](https://www.npmjs.com/package/art-template) |
| nodemailer    | å‘é€ç”µå­é‚®ä»¶ | [æŸ¥çœ‹npmé¡¹ç›®åœ°å€](https://www.npmjs.com/package/nodemailer) |
| node-schedule | å®šæ—¶ä»»åŠ¡   | [æŸ¥çœ‹npmé¡¹ç›®åœ°å€](https://www.npmjs.com/package/node-schedule) |

1. åˆå§‹åŒ–é¡¹ç›®

```shell
npm init -y
```

2. å®‰è£…é¡¹ç›®æ‰€æœ‰ä¾èµ–åŒ…

```shell
npm install superagent cheerio art-template node-schedule nodemailer
```



## é‚®ä»¶å†…å®¹å¸ƒå±€å‚è€ƒ

æ³¨æ„äº‹é¡¹ï¼šé‚®ä»¶åªå…è®¸è¡Œå†…æ ·å¼ã€‚

```html
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>çˆ±çš„é‚®ä»¶</title>
    </head>
    <body style="margin:0;padding:0;">
        <div
            style="width:100%; margin: 40px auto;font-size:20px; color:#5f5e5e;text-align:center"
        >
            <span>ä»Šå¤©æ˜¯æˆ‘ä»¬åœ¨ä¸€èµ·çš„ç¬¬</span>
            <span style="font-size:24px;color:rgb(221, 73, 73)">
                520
            </span>
            <span>å¤©</span>
        </div>
        <div style="width:100%; margin: 0 auto;color:#5f5e5e;text-align:center">
            <img
                style="background: #0097e0"
                src="https://h5tq.moji.com/tianqi/assets/images/weather/w2.png"
                alt="å¤©æ°”å›¾æ ‡"
            />
            <b style="display:block;color:#333;font-size:24px;margin:15px 0;"
                >å¤©æ°”ï¼šé˜´</b
            >
            <span style="display:block;color:#333;font-size:22px;margin:15px 0;"
                >æ¸©åº¦ï¼š19</span
            >

            <span style="display:block;color:#676767;font-size:20px"
                >æç¤ºï¼šä»Šå¤©æœ‰é›¨ï¼Œå†·çƒ­é€‚å®œï¼Œæ„Ÿè§‰å¾ˆèˆ’é€‚ã€‚</span
            >
        </div>
        <div style="text-align:center;margin:35px 0;">
            <span
                style="display:block;margin-top:55px;color:#676767;font-size:15px"
                >ONE Â· ä¸€ä¸ª</span
            >
            <span
                style="display:block;margin-top:25px;font-size:22px; color:#9d9d9d; "
                >2019 / 3 / 14</span
            >
            <img
                src="http://image.wufazhuce.com/FhACc4YBWRGpOGfiIUrpPz4BmcVB"
                style="width:100%;margin-top:10px;"
                alt="ONEé…å›¾"
            />
            <div style="margin:10px auto;width:85%;color:#5f5e5e;">
                è‹¥æ·±æƒ…ä¸èƒ½å¯¹ç­‰ï¼Œæ„¿çˆ±å¾—æ›´å¤šçš„äººæ˜¯æˆ‘ã€‚
            </div>
        </div>
    </body>
</html>

```



## é‚®ç®±è®¾ç½®

### 163é‚®ç®±è®¾ç½®

![1552598940468](assets/1552598940468.png)

> è®¾ç½®å®¢æˆ·ç«¯æˆæƒå¯†ç 

![1552599425968](assets/1552599425968.png)

### QQé‚®ç®±è´¦å·è®¾ç½®

![1552599808726](assets/1552599808726.png)



ç½‘æ˜“é‚®ç®±ç«¯å£å·

![163ç«¯å£å·](assets/201102010936447869c.png)

QQé‚®ç®±ç«¯å£å·

![1552550442868](assets/1552550442868.png)

## Node å‘é€é‚®ä»¶ä¸­æ–‡æ³¨é‡Š

```js
// å¯¼å…¥ å‘é€é‚®ä»¶çš„åŒ…
const nodemailer = require("nodemailer");

async function sendNodeMail() {
    // HTML é¡µé¢å†…å®¹
    const html = "<h1>è¿™æ˜¯HTMLå†…å®¹666</h1>";
    console.log(html);
    // ä½¿ç”¨é»˜è®¤SMTPä¼ è¾“ï¼Œåˆ›å»ºå¯é‡ç”¨é‚®ç®±å¯¹è±¡
    let transporter = nodemailer.createTransport({
        host: "smtp.163.com",
        port: 465,
        secure: true, // å¼€å¯åŠ å¯†åè®®ï¼Œéœ€è¦ä½¿ç”¨ 465 ç«¯å£å·
        auth: {
            user: "gzqd201802@163.com", // ç”¨æˆ·å
            pass: "1234qwer" // æˆæƒå¯†ç 
        }
    });

    // è®¾ç½®ç”µå­é‚®ä»¶æ•°æ®
    let mailOptions = {
        from: '"å¹¿å·ä¼ æ™ºæ’­å®¢å‰ç«¯" <gzqd201802@163.com>', // å‘ä»¶äººé‚®ç®±
        to: "gzqd201803@163.cn", // æ”¶ä»¶äººåˆ—è¡¨
        subject: "ä¸€å°çˆ±çš„é‚®ä»¶", // æ ‡é¢˜
        html: html // html å†…å®¹
    };

    transporter.sendMail(mailOptions, (error, info = {}) => {
        if (error) {
            console.log(error);
            sendNodeMail(); //å†æ¬¡å‘é€
        }
        console.log("é‚®ä»¶å‘é€æˆåŠŸ", info.messageId);
        console.log("é™ç­‰ä¸‹ä¸€æ¬¡å‘é€");
    });
}
```



# ğŸ“™ é¡¹ç›®å‚è€ƒä»£ç 

> è®°å¾—ä¿®æ”¹æˆè‡ªå·±çš„é‚®ç®±åœ°å€ï¼ï¼ï¼

1. åˆå§‹åŒ–é¡¹ç›®

```shell
npm init -y
```

2. å®‰è£…é¡¹ç›®æ‰€æœ‰ä¾èµ–åŒ…

```shell
npm install superagent cheerio art-template node-schedule nodemailer
```

3.  æ ¸å¿ƒä»£ç å‚è€ƒ

```js
// 2.0 å¼•å…¥ superagent åŒ…ï¼Œç”¨äº Node æœåŠ¡å™¨å‘é€httpè¯·æ±‚
const request = require("superagent");
// 3.0 å¯¼å…¥ cheerioï¼ŒæŠŠå­—ç¬¦ä¸²è§£ææˆ HTML
const cheerio = require("cheerio");
// 4.0 å¯¼å…¥æ¨¡æ¿å¼•æ“
const template = require("art-template");
// 4.0.1 å¯¼å…¥ path æ¨¡å—å¤„ç†è·¯å¾„
const path = require("path");
// 5.0 å¯¼å…¥ å‘é€é‚®ä»¶çš„åŒ…
const nodemailer = require("nodemailer");
// 6.0 å¯¼å…¥ å®šæ—¶ä»»åŠ¡æ¨¡å—
const schedule = require("node-schedule");

// 1.0 è®¡ç®—çˆ±äººè®¤è¯†çš„å¤©æ•°
function getDayData() {
    return new Promise((resolve, reject) => {
        // ç°åœ¨çš„æ—¶é—´
        const today = new Date();
        // è®¤è¯†çš„æ—¶é—´ 2019-03-01
        const meet = new Date("2019-03-01");
        // è®¡ç®—ç›¸è¯†åˆ°ä»Šå¤©çš„å¤©æ•°ï¼Œæ¯«ç§’å€¼ï¼Œ1000æ¯«ç§’1ç§’ï¼Œ60ç§’1åˆ†ï¼Œ60åˆ†1å°æ—¶ï¼Œ24å°æ—¶1å¤©
        const count = Math.ceil((today - meet) / 1000 / 60 / 60 / 24);
        // ä»Šå¤©æ—¥æœŸæ ¼å¼åŒ–
        const format =
            today.getFullYear() +
            " / " +
            (today.getMonth() + 1) +
            " / " +
            today.getDate();
        const dayData = {
            count,
            format
        };
        // console.log(dayData);
        resolve(dayData);
    });
}
// getDayData();

// 2.1 è¯·æ±‚å¢¨è¿¹å¤©æ°”è·å–æ•°æ®
function getMojiData() {
    return new Promise((resolve, reject) => {
        request
            .get("https://tianqi.moji.com/weather/china/guangdong/guangzhou")
            .end((err, res) => {
                if (err) return console.log("æ•°æ®è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥è·¯å¾„");
                // console.log(res.text);
                // æŠŠå­—ç¬¦ä¸²è§£ææˆTHMLï¼Œå¹¶å¯ç”¨ jQuery æ ¸å¿ƒé€‰æ‹©å™¨è·å–å†…å®¹
                const $ = cheerio.load(res.text);
                // å›¾æ ‡
                const icon = $(".wea_weather span img").attr("src");
                // å¤©æ°”
                const weather = $(".wea_weather b").text();
                // æ¸©åº¦
                const temperature = $(".wea_weather em").text();
                // æç¤º
                const tips = $(".wea_tips em").text();
                // å¢¨è¿¹å¤©æ°”æ•°æ®
                const mojiData = {
                    icon,
                    weather,
                    temperature,
                    tips
                };
                // console.log(mojiData);
                resolve(mojiData);
            });
    });
}
// getMojiData();

// 3.1 è¯·æ±‚ One é¡µé¢æŠ“å–æ•°æ®
function getOneData() {
    return new Promise((resolve, reject) => {
        request.get("http://wufazhuce.com/").end((err, res) => {
            if (err) return console.log("è¯·æ±‚å¤±è´¥");

            // æŠŠè¿”å›å€¼ä¸­çš„é¡µé¢è§£ææˆ HTML
            const $ = cheerio.load(res.text);
            // æŠ“å– one çš„å›¾ç‰‡
            const img = $(
                ".carousel-inner>.item>img, .carousel-inner>.item>a>img"
            )
                .eq(0)
                .attr("src");
            // æŠ“å– one çš„æ–‡æœ¬
            const text = $(".fp-one .fp-one-cita-wrapper .fp-one-cita a")
                .eq(0)
                .text();
            // one æ•°æ®
            const oneData = {
                img,
                text
            };
            // console.log(oneData);
            resolve(oneData);
        });
    });
}
// getOneData();

// 4.0 é€šè¿‡æ¨¡æ¿å¼•èµ·æ›¿æ¢ HTML çš„æ•°æ®
async function renderTemplate() {
    // è·å– æ—¥æœŸ
    const dayData = await getDayData();
    // è·å– å¢¨è¿¹å¤©æ°”æ•°æ®
    const mojiData = await getMojiData();
    // è·å– One çš„æ•°æ®
    const oneData = await getOneData();
    // console.log(dayData);
    // console.log(mojiData);
    // console.log(oneData);
    // 2. æ‰€æœ‰æ•°æ®éƒ½è·å–æˆåŠŸçš„æ—¶å€™ï¼Œæ‰è¿›è¡Œæ¨¡æ¿å¼•æ“æ•°æ®çš„æ›¿æ¢
    return new Promise((resolve, reject) => {
        const html = template(path.join(__dirname, "./love.html"), {
            dayData,
            mojiData,
            oneData
        });
        // console.log(html);
        resolve(html);
    });
}
// renderTemplate();

// 5. å‘é€é‚®ä»¶
async function sendNodeMail() {
    // HTML é¡µé¢å†…å®¹ï¼Œé€šè¿‡ await ç­‰å¾…æ¨¡æ¿å¼•æ“æ¸²æŸ“å®Œæ¯•åï¼Œå†å¾€ä¸‹æ‰§è¡Œä»£ç 
    const html = await renderTemplate();
    // console.log(html);
    // ä½¿ç”¨é»˜è®¤SMTPä¼ è¾“ï¼Œåˆ›å»ºå¯é‡ç”¨é‚®ç®±å¯¹è±¡
    let transporter = nodemailer.createTransport({
        host: "smtp.163.com",
        port: 465,
        secure: true, // å¼€å¯åŠ å¯†åè®®ï¼Œéœ€è¦ä½¿ç”¨ 465 ç«¯å£å·
        auth: {
            user: "***@163.com", // ç”¨æˆ·å
            pass: "***" // å®¢æˆ·ç«¯æˆæƒå¯†ç 
        }
    });

    // è®¾ç½®ç”µå­é‚®ä»¶æ•°æ®
    let mailOptions = {
        from: '"å¸…æ°”çš„å°å“¥å“¥" <***@163.com>', // å‘ä»¶äººé‚®ç®±
        to: "***@**.com", // æ”¶ä»¶äººåˆ—è¡¨
        subject: "è¿™ä¸ªä¸€å°å……æ»¡çˆ±çš„é‚®ä»¶", // æ ‡é¢˜
        html: html // html å†…å®¹
    };
    // å‘é€é‚®ä»¶
    transporter.sendMail(mailOptions, (error, info = {}) => {
        if (error) {
            console.log(error);
            sendNodeMail(); //å†æ¬¡å‘é€
        }
        console.log("é‚®ä»¶å‘é€æˆåŠŸ", info.messageId);
        console.log("é™ç­‰ä¸‹ä¸€æ¬¡å‘é€");
    });
}
// sendNodeMail();

// 6. å®šæ—¶æ¯å¤© 5æ—¶20åˆ†14ç§’å‘é€é‚®ä»¶ç»™å¥³ï¼ˆç”·ï¼‰æœ‹å‹
// 6.1 åˆ›å»ºå®šæ—¶å™¨ä»»åŠ¡
schedule.scheduleJob("14 20 5 * * *", function() {
    // æ—¶é—´åˆ°äº†ï¼Œæ‰§è¡Œå‘é€é‚®ä»¶çš„ä»»åŠ¡
    sendNodeMail();
    console.log("å®šæ—¶ä»»åŠ¡çš„é‚®ä»¶å‘é€æˆåŠŸ");
});

```

